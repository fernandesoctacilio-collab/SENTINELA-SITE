
const $=(s,r=document)=>r.querySelector(s);const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
document.addEventListener('DOMContentLoaded',()=>{const io=new IntersectionObserver(e=>{for(const n of e){if(n.isIntersecting){n.target.classList.add('revealed');io.unobserve(n.target)}}},{threshold:.12});$$('.reveal').forEach(el=>io.observe(el));$$('img[data-reveal-img]').forEach(img=>{if(img.complete)img.classList.add('ready');else img.addEventListener('load',()=>img.classList.add('ready'))});const header=$('.site-header');window.addEventListener('scroll',()=>{if((window.scrollY||0)>10){header&&header.classList&&header.classList.add('scrolled')}else{header&&header.classList&&header.classList.remove('scrolled')}},{passive:true});const nav=$('.nav'),burger=$('.burger');burger&&burger.addEventListener('click',()=>nav.classList.toggle('open'));const topBtn=$('#backToTop');if(topBtn){window.addEventListener('scroll',()=>{if((window.scrollY||0)>400)topBtn.classList.add('show');else topBtn.classList.remove('show')},{passive:true});topBtn.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}))}});
// Splash
(()=>{const splash=$('#splash');const img=$('#splashGif');if(!splash)return;if(img&&!img.src)img.src=encodeURI('assets/img/animação.gif');const hide=()=>{splash.classList.add('fade-out');setTimeout(()=>splash.remove(),800)};if(img){img.addEventListener('load',()=>setTimeout(hide,6000),{once:true});img.addEventListener('error',()=>setTimeout(hide,500),{once:true})}setTimeout(hide,9000)})();
// Carousel
function setupCarousel(id,interval=4500){const t=document.getElementById(id);if(!t)return;const p=document.querySelector(`.car-btn.prev[data-for="${id}"]`);const n=document.querySelector(`.car-btn.next[data-for="${id}"]`);function w(){const f=t.querySelector('.card');try{return f?f.getBoundingClientRect().width+18:320}catch(e){return 320}}p&&p.addEventListener('click',()=>t.scrollBy({left:-w(),behavior:'smooth'}));n&&n.addEventListener('click',()=>t.scrollBy({left:w(),behavior:'smooth'}));setInterval(()=>{if(!document.body.contains(t))return;t.scrollBy({left:w(),behavior:'smooth'});if(t.scrollLeft+t.clientWidth>=t.scrollWidth-w()){setTimeout(()=>t.scrollTo({left:0,behavior:'smooth'}),600)}},interval)}
function initCarousels(){setupCarousel('newsGrid',4500);setupCarousel('explicaGrid',5000)}
async function fetchJSON(p){const r=await fetch(p,{cache:'no-store'});return r.json()}
async function renderHomepage(){const newsGrid=document.getElementById('newsGrid');const explicaGrid=document.getElementById('explicaGrid');try{const [news,exp]=await Promise.all([fetchJSON('assets/data/news.json'),fetchJSON('assets/data/explica.json')]);if(newsGrid){newsGrid.innerHTML='';news.slice(0,6).forEach((n)=>{const a=document.createElement('a');a.className='card reveal';a.href=(n&&n.url)?n.url:'#';a.innerHTML=`<img loading="lazy" data-reveal-img class="cover" src="${n.image||'https://picsum.photos/seed/nw/1200/700'}" alt="${n.title}"><div class="p"><span class="chip">${n.tag||''}</span><h3>${n.title}</h3><p>${n.summary||''}</p></div>`;newsGrid.appendChild(a)})}if(explicaGrid){explicaGrid.innerHTML='';exp.slice(0,6).forEach((e)=>{const a=document.createElement('a');a.className='card reveal';a.href='pages/explica.html#'+e.slug;a.innerHTML=`<img loading="lazy" data-reveal-img class="cover" src="${e.image}" alt="${e.title}"><div class="p"><h3>${e.title}</h3><p>${e.summary}</p></div>`;explicaGrid.appendChild(a)})}}catch(e){console.warn('Seeds falharam',e)}}
renderHomepage().then(()=>{initCarousels()}).catch(()=>{initCarousels()});
// Feeds regionais multi-fonte
(async function(){const grid=document.getElementById('newsGrid');if(!grid||!window.SENTINELA_FEEDS)return;const {sources,fallbackLinks}=window.SENTINELA_FEEDS;function render(items){grid.innerHTML='';items.slice(0,12).forEach((it,i)=>{const a=document.createElement('a');a.className='card reveal';a.target='_blank';a.rel='noopener';a.href=it.link||'#';const img=(it.image&&it.image!=='undefined')?it.image:('https://picsum.photos/seed/vale'+i+'/1200/700');a.innerHTML=`<img loading="lazy" data-reveal-img class="cover" src="${img}" alt="${it.title}"><div class="p"><span class="chip">${it.tag||'Regional'}</span><h3>${it.title}</h3><p>${(it.description||'').slice(0,140)}...</p></div>`;grid.appendChild(a)})}
try{const t=await fetch(sources.google_news,{cache:'no-store'}).then(r=>r.text());const items=[];const re=/<item>([\s\S]*?)<\/item>/g;let m;while((m=re.exec(t))){const b=m[1];const get=tag=>{const rr=new RegExp(`<${tag}>([\\s\\S]*?)<\/${tag}>`,'i');const mm=rr.exec(b);return mm?mm[1].replace(/<!\\[CDATA\\[|\\]\\]>/g,'').trim():''};const title=get('title'),link=get('link');let desc=get('description').replace(/<[^>]+>/g,'');let img='';const thumb=b.match(/<media:thumbnail[^>]*url="([^"]+)"/i);if(thumb)img=thumb[1];const srcDescImg=desc.match(/https?:\/\/[^"'\s>]+?\.(?:jpg|jpeg|png|webp)/i);if(!img&&srcDescImg)img=srcDescImg[0];if(title&&link)items.push({title,link,image:img,description:desc,tag:'Google News'})}if(items.length){render(items);return}throw new Error('empty google')}catch(e){console.warn('GoogleNews falhou',e)}
try{const r=await fetch(sources.g1_rss2json,{cache:'no-store'});if(!r.ok)throw new Error('rss2json '+r.status);const d=await r.json();const items=(d.items||[]).map(x=>({title:x.title,link:x.link,image:x.thumbnail||(x.enclosure&&(x.enclosure.link||x.enclosure.url)),description:(x.description||'').replace(/<[^>]+>/g,''),tag:'G1 Vale'}));if(items.length){render(items);return}throw new Error('empty')}catch(e){console.warn('rss2json falhou',e)}
try{const t=await fetch(sources.g1_xml,{cache:'no-store'}).then(r=>r.text());const items=[];const re=/<item>([\s\S]*?)<\/item>/g;let m;while((m=re.exec(t))){const b=m[1];const get=tag=>{const rr=new RegExp(`<${tag}>([\\s\\S]*?)<\/${tag}>`,'i');const mm=rr.exec(b);return mm?mm[1].replace(/<!\\[CDATA\\[|\\]\\]>/g,'').trim():''};const title=get('title'),link=get('link');let image='';const mt=b.match(/<media:thumbnail[^>]*url="([^"]+)"/i);if(mt)image=mt[1];const me=b.match(/<enclosure[^>]*url="([^"]+)"/i);if(!image&&me)image=me[1];const desc=get('description').replace(/<[^>]+>/g,'');if(title&&link)items.push({title,link,image,description:desc,tag:'G1 Vale'})}if(items.length){render(items);return}throw new Error('empty')}catch(e){console.warn('G1 XML falhou',e)}
try{const h=await fetch(sources.g1_html,{cache:'no-store'}).then(r=>r.text());const items=[];const re=/<a[^>]+href="(https?:\/\/g1\.globo\.com[^"]+)"[^>]*>(.*?)<\/a>/gi;let m;const seen=new Set();while((m=re.exec(h))){const link=m[1];const text=m[2].replace(/<[^>]+>/g,'').trim();if(text.length<28)continue;const key=link+'|'+text;if(seen.has(key))continue;seen.add(key);items.push({title:text,link,image:'',description:'',tag:'G1 Vale'});if(items.length>=12)break}if(items.length){render(items);return}throw new Error('empty')}catch(e){console.warn('G1 HTML falhou',e)}
try{const h=await fetch(sources.ovale_html,{cache:'no-store'}).then(r=>r.text());const items=[];const re=/<a[^>]+href="(https?:\/\/www\.ovale\.com\.br[^"]+)"[^>]*>(.*?)<\/a>/gi;let m;const seen=new Set();while((m=re.exec(h))){const link=m[1];const text=m[2].replace(/<[^>]+>/g,'').trim();if(text.length<28)continue;const key=link+'|'+text;if(seen.has(key))continue;seen.add(key);items.push({title:text,link,image:'',description:'',tag:'O Vale'});if(items.length>=12)break}if(items.length){render(items);return}throw new Error('empty')}catch(e){console.warn('OVale falhou',e)}
try{const h=await fetch(sources.vale360_html,{cache:'no-store'}).then(r=>r.text());const items=[];const re=/<a[^>]+href="(https?:\/\/www\.vale360\.com\.br[^"]+)"[^>]*>(.*?)<\/a>/gi;let m;const seen=new Set();while((m=re.exec(h))){const link=m[1];const text=m[2].replace(/<[^>]+>/g,'').trim();if(text.length<28)continue;const key=link+'|'+text;if(seen.has(key))continue;seen.add(key);items.push({title:text,link,image:'',description:'',tag:'Vale360'});if(items.length>=12)break}if(items.length){render(items);return}throw new Error('empty')}catch(e){console.warn('Vale360 falhou',e)}
grid.innerHTML='';fallbackLinks.forEach((l)=>{const a=document.createElement('a');a.className='card reveal';a.href=l.url;a.target='_blank';a.rel='noopener';a.innerHTML=`<div class="p"><h3>${l.title}</h3><p>Abrir em nova aba</p></div>`;grid.appendChild(a)});
})();
// Noticias page
(async function(){const list=document.getElementById('newsList');if(!list)return;const data=await fetchJSON('../assets/data/news.json');const search=document.getElementById('searchNews');function draw(items){list.innerHTML='';items.forEach((n)=>{const a=document.createElement('a');a.className='card reveal';a.href=(n&&n.url)?n.url:'#';a.innerHTML=`<img loading="lazy" data-reveal-img class="cover" src="${n.image}" alt="${n.title}"><div class="p"><span class="chip">${n.tag||''}</span><h3>${n.title}</h3><p>${n.summary||''}</p></div>`;list.appendChild(a)})}draw(data);search&&search.addEventListener('input',()=>{const term=search.value.toLowerCase();const filtered=data.filter(n=>(n.title+n.summary+(n.tag||'')).toLowerCase().includes(term));draw(filtered)})})();
// Explica page
(async function(){const list=document.getElementById('explicaList');if(!list)return;const data=await fetchJSON('../assets/data/explica.json');const modal=document.getElementById('modal');const modalBody=document.getElementById('modalBody');const close=document.getElementById('closeModal');function open(item){if(!modal)return;modalBody.innerHTML=`<h2>${item.title}</h2><p>${item.content}</p>`;modal.style.display='block'};close&&close.addEventListener('click',()=>modal.style.display='none');data.forEach((e)=>{const a=document.createElement('a');a.className='card reveal';a.href='#'+e.slug;a.addEventListener('click',ev=>{ev.preventDefault();open(e)});a.innerHTML=`<img loading="lazy" data-reveal-img class="cover" src="${e.image}" alt="${e.title}"><div class="p"><h3>${e.title}</h3><p>${e.summary}</p></div>`;list.appendChild(a)})})();
// Ajuda - FAQ + LAI Calc + Gerador
(async function(){const faq=document.getElementById('faq');if(!faq)return;const list=await fetchJSON('../assets/data/faqs.json');list.forEach(({q,a})=>{const item=document.createElement('div');item.className='item';item.innerHTML=`<div class="q">${q}<span>+</span></div><div class="a"><p>${a}</p></div>`;const qEl=item.querySelector('.q');const aEl=item.querySelector('.a');qEl.addEventListener('click',()=>{const open=item.classList.toggle('open');aEl.style.height=open?aEl.scrollHeight+'px':'0px';qEl.querySelector('span').textContent=open?'−':'+'});faq.appendChild(item)});const base=document.getElementById('diasBase'),prog=document.getElementById('diasProrroga'),inicio=document.getElementById('dataInicio'),btn=document.getElementById('calcPrazo'),res=document.getElementById('prazoResultado');btn&&btn.addEventListener('click',()=>{const start=inicio.value?new Date(inicio.value):new Date();const end=new Date(start.getTime());end.setDate(end.getDate()+parseInt(base.value||'20',10)+parseInt(prog.value||'10',10));const dd=String(end.getDate()).padStart(2,'0');const mm=String(end.getMonth()+1).padStart(2,'0');const yy=end.getFullYear();res.textContent=`Prazo estimado (com prorrogação): ${dd}/${mm}/${yy}`})})();
// Denúncia
(function(){const form=document.getElementById('denunciaForm');if(!form)return;const K='sentinela_denuncia';const desc=document.getElementById('desc'),assunto=document.getElementById('assunto'),email=document.getElementById('email'),tel=document.getElementById('telefone');const prevBtn=document.getElementById('previewDenuncia'),saveBtn=document.getElementById('salvarRascunho'),protBtn=document.getElementById('gerarProtocolo');const status=document.getElementById('statusDenuncia');const modal=document.getElementById('modalDenuncia');const close=document.getElementById('closeDenuncia');const out=document.getElementById('conteudoPreview');function validate(){if(!desc.value.trim()){status.textContent='Descreva os fatos (obrigatório).';return false}status.textContent='';return true}function docText(){return `DENÚNCIA

Assunto: ${assunto.value||'(não informado)'}

Descrição:
${desc.value}

Contato: ${email.value||'-'} / ${tel.value||'-'}`}prevBtn&&prevBtn.addEventListener('click',()=>{if(!validate())return;out.textContent=docText();modal.style.display='block'});close&&close.addEventListener('click',()=>modal.style.display='none');saveBtn&&saveBtn.addEventListener('click',()=>{localStorage.setItem(K,JSON.stringify({assunto:assunto.value,desc:desc.value,email:email.value,telefone:tel.value}));status.textContent='Rascunho salvo localmente.'});try{const d=JSON.parse(localStorage.getItem(K)||'{}');assunto.value=d.assunto||'';desc.value=d.desc||'';email.value=d.email||'';tel.value=d.telefone||''}catch{}protBtn&&protBtn.addEventListener('click',()=>{const proto='SNT-'+Date.now().toString(36).toUpperCase();status.textContent='Protocolo gerado: '+proto})})();
